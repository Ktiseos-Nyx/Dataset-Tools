{
  "parser_name": "A1111 String (Workflow Present)",
  "priority": 165,
  "description": "A1111-style parameter strings in images that also contain ComfyUI workflows. Prioritizes the A1111 text extraction over workflow parsing.",
  "version": "1.0",
  "maintainer": "Dataset-Tools",
  "target_file_types": ["PNG", "JPEG", "WEBP"],

  "detection_rules": [
    {
      "comment": "Rule 1: Must have A1111-style parameter text with standard fields",
      "source_type": "a1111_parameter_string_content",
      "operator": "regex_match_all",
      "regex_patterns": ["Steps:", "Sampler:", "CFG scale:", "Seed:", "Size:"]
    },
    {
      "comment": "Rule 2: Must have 'parameters' chunk in PIL info (where A1111 text is stored)",
      "source_type": "pil_info_key",
      "source_key": "parameters",
      "operator": "exists"
    },
    {
      "comment": "Rule 3: Must NOT be Civitai (let Civitai parser handle those)",
      "operator": "NOT",
      "rules": [
        {
          "source_type": "a1111_parameter_string_content",
          "operator": "regex_match_any",
          "regex_patterns": ["Civitai resources:", "Civitai metadata:"]
        }
      ]
    }
  ],

  "parsing_instructions": {
    "input_data": {
      "source_options": [
        {"source_type": "pil_info_key", "source_key": "parameters"},
        {"source_type": "exif_user_comment"}
      ],
      "transformations": [
        {"type": "conditional_json_unwrap_parameters_string"}
      ]
    },
    "extraction_strategy": "a1111_text_parsing",
    "format_description": "A1111 text format with prompts and key-value parameters, workflow ignored",
    "fields": [
      {
        "comment": "Extract the full workflow for debugging/inspection",
        "target_key": "raw_workflow_json",
        "method": "direct_context_key",
        "context_key": "comfyui_workflow_json",
        "optional": true
      },
      {
        "comment": "Detect if this is ComfyRoll workflow specifically",
        "target_key": "is_comfyroll",
        "method": "context_workflow_contains_string",
        "search_string": "\"class_type\": \"CR ",
        "optional": true
      },
      {
        "target_key": "prompt",
        "method": "a1111_extract_prompt_positive"
      },
      {
        "target_key": "negative_prompt",
        "method": "a1111_extract_prompt_negative"
      },
      {
        "target_key": "parameters.steps",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Steps",
        "value_type": "integer"
      },
      {
        "target_key": "parameters.sampler",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Sampler",
        "value_type": "string"
      },
      {
        "target_key": "parameters.cfg_scale",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "CFG scale",
        "value_type": "float"
      },
      {
        "target_key": "parameters.seed",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Seed",
        "value_type": "integer"
      },
      {
        "target_key": "parameters.size",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Size",
        "value_type": "string"
      },
      {
        "target_key": "parameters.model",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Model",
        "value_type": "string",
        "optional": true
      },
      {
        "target_key": "parameters.model_hash",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Model hash",
        "value_type": "string",
        "optional": true
      },
      {
        "target_key": "parameters.version",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Version",
        "value_type": "string",
        "optional": true
      }
    ],
    "output_template": {
      "tool": "A1111 Format (Workflow Present)",
      "parser": "a1111_string_with_workflow",
      "prompt": "$prompt",
      "negative_prompt": "$negative_prompt",
      "parameters": {
        "steps": "$parameters.steps",
        "sampler": "$parameters.sampler",
        "cfg_scale": "$parameters.cfg_scale",
        "seed": "$parameters.seed",
        "size": "$parameters.size",
        "model": "$parameters.model",
        "model_hash": "$parameters.model_hash",
        "version": "$parameters.version"
      },
      "system_info": {
        "note": "Image contains both A1111 parameter string and ComfyUI workflow",
        "extraction_source": "A1111 parameter text",
        "workflow_ignored": true
      },
      "_metadata": {
        "processed_at": "$CURRENT_TIMESTAMP",
        "processor": "MetadataEngine",
        "template_processed": true
      }
    }
  },
  "notes": [
    "Priority 165 puts it above standard a1111_webui (170) but below Civitai (172)",
    "Handles hybrid images where ComfyUI workflow exists but A1111 text is the source of truth",
    "Common in ComfyUI workflows that output A1111-compatible metadata",
    "Workflow is ignored - extraction happens from parameter text only"
  ]
}
